<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Admin API</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .error {
            background: #fee;
            border-left: 4px solid #f00;
            padding: 15px;
            margin: 10px 0;
        }
        .success {
            background: #efe;
            border-left: 4px solid #0f0;
            padding: 15px;
            margin: 10px 0;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>üîç Test Admin Statistics API</h1>
    
    <div class="card">
        <h2>Test Configuration</h2>
        <p><strong>API Base URL:</strong> <span id="apiUrl">Loading...</span></p>
        <p><strong>Year:</strong> 2025</p>
        <p><strong>Disease Type:</strong> <select id="diseaseType">
            <option value="dm">Diabetes Mellitus (DM)</option>
            <option value="ht">Hipertensi (HT)</option>
        </select></p>
        <button onclick="testAPI()">Test API Endpoint</button>
        <button onclick="location.reload()" style="background: #ff9800;">Clear Browser Cache & Reload</button>
    </div>
    
    <div class="card">
        <h2>API Response</h2>
        <div id="result" class="loading">Click button to test...</div>
    </div>

    <script>
        // Get API URL from environment
        const API_BASE_URL = 'http://localhost:8000/api';
        document.getElementById('apiUrl').textContent = API_BASE_URL;
        
        // Token - you need to login first and paste token here
        const TOKEN = 'YOUR_ADMIN_TOKEN_HERE';
        
        async function testAPI() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p class="loading">Testing API...</p>';
            
            const diseaseType = document.getElementById('diseaseType').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/statistics/admin?year=2025&disease_type=${diseaseType}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${TOKEN}`
                    },
                    cache: 'no-store' // Disable browser cache
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Extract summary data
                    const summary = data.summary?.[diseaseType] || {};
                    
                    let html = '<div class="success"><strong>‚úÖ API Response Success!</strong></div>';
                    html += '<h3>Summary Cards (What Dashboard Shows):</h3>';
                    html += '<ul>';
                    html += `<li><strong>Total Puskesmas:</strong> ${data.total_puskesmas || 0}</li>`;
                    html += `<li><strong>Sasaran (Target):</strong> ${summary.target || 0}</li>`;
                    html += `<li><strong>Capaian Standar:</strong> ${summary.standard_patients || 0}</li>`;
                    html += `<li><strong>Capaian Tidak Standar:</strong> ${summary.non_standard_patients || 0}</li>`;
                    html += `<li><strong>Total Pelayanan:</strong> ${summary.total_patients || 0}</li>`;
                    html += `<li><strong>% Capaian:</strong> ${summary.achievement_percentage || '0%'}</li>`;
                    html += '</ul>';
                    
                    if (summary.total_patients > 0) {
                        html += '<div class="error"><strong>‚ö†Ô∏è WARNING:</strong> total_patients is not 0! This is what shows as "121" in frontend.</div>';
                        html += '<p><strong>This means:</strong></p>';
                        html += '<ul>';
                        html += '<li>Either the database has examination data, OR</li>';
                        html += '<li>Backend is connected to wrong database</li>';
                        html += '</ul>';
                    } else {
                        html += '<div class="success"><strong>‚úÖ CORRECT:</strong> All values are 0 (clean database)</div>';
                    }
                    
                    html += '<h3>Full API Response:</h3>';
                    html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<div class="error"><strong>Error ${response.status}:</strong> ${data.message || 'Unknown error'}</div>`;
                    resultDiv.innerHTML += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error"><strong>Network Error:</strong> ${error.message}</div>`;
                resultDiv.innerHTML += '<p>Make sure:</p><ul>';
                resultDiv.innerHTML += '<li>Laravel backend is running (php artisan serve)</li>';
                resultDiv.innerHTML += '<li>You are logged in as admin</li>';
                resultDiv.innerHTML += '<li>You have pasted admin token in the script</li>';
                resultDiv.innerHTML += '</ul>';
            }
        }
        
        // Instructions
        console.log('='.repeat(80));
        console.log('TO USE THIS TESTER:');
        console.log('1. Login as admin in the main application');
        console.log('2. Open browser DevTools (F12) > Application > Local Storage');
        console.log('3. Find "token" and copy its value');
        console.log('4. Paste it in the TOKEN variable above (line 94)');
        console.log('5. Click "Test API Endpoint" button');
        console.log('='.repeat(80));
    </script>
</body>
</html>
